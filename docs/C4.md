# Decode Backend C4 Documentation

Decode Backend v2 is implemented as a NestJS microservices landscape. This document captures the Level 2 (Container) and Level 3 (Component) views that drive the system’s C4 model. Use it as the authoritative reference when drawing diagrams or onboarding new engineers.

---

## Level 2 – Container View

### External Actors
- **Decode Web / Mobile Clients** – End-users interacting over HTTPS/WebSocket with the API Gateway and Notification service.
- **Operations & Observability Stack** – CI/CD pipelines, Datadog APM, and engineers accessing service health endpoints.

### Core Containers

| Container | Tech / Runtime | Responsibilities | Interfaces | Key Dependencies |
|-----------|----------------|------------------|------------|------------------|
| **API Gateway** (`apps/api-gateway`, port 4000) | NestJS 11, Node 18 | Single entry point, request validation, rate limiting, auth guards, REST aggregation, Swagger docs | REST (`/auth`, `/users`, `/wallet`, `/relationship`, `/notifications`), WebSocket upgrade proxy | Auth, User, Wallet, Relationship, Notification microservices; MongoDB for session lookups; Redis cache |
| **Auth Service** (`apps/auth`, port 4001) | NestJS 11 | Registration, login, MFA, device fingerprinting, token/session lifecycle, SSO issuance | REST `/auth/*`, internal service endpoints, RabbitMQ events | MongoDB (users, sessions), Redis (rate limiting/device cache), RabbitMQ (email + notification triggers) |
| **User Service** (`apps/user`, port 4002) | NestJS 11 | Profile management, username/email workflows, privacy + deactivation, search APIs | REST `/users/*`, service-token guarded endpoints | MongoDB (`users` collection), Redis (profile cache), Auth service (JWT validation) |
| **Email Worker** (`apps/email-worker`, port 4003) | NestJS worker | Consumes RabbitMQ email jobs, renders templates, sends SMTP mails, reports metrics | RabbitMQ consumer, REST health | RabbitMQ, SMTP provider, Datadog metrics |
| **Relationship Service** (`apps/relationship`, port 4004) | NestJS 11 + Neo4j driver | Follow/block graph, mutual discovery, interests, follower snapshots | REST `/relationship/*`, service endpoints for snapshots | Neo4j (graph), MongoDB (snapshots), Redis (recommendation cache), RabbitMQ (events), Auth service |
| **Wallet Service** (`apps/wallet`, port 4005) | NestJS 11 | Wallet linking, ownership verification, primary wallet selection, crypto utilities | REST `/wallet/*`, service JWT endpoints | MongoDB (`wallets`), Redis (session cache), Auth service (wallet sessions) |
| **Notification Service** (`apps/notification`, port 4006) | NestJS 11 + Socket.IO | Stores notifications, serves REST queries, pushes WebSocket events, consumes RabbitMQ notification queue | REST `/notifications/*`, WebSocket namespace `/notifications`, RabbitMQ consumer | MongoDB (`notifications`), Redis (WebSocket session store), RabbitMQ |
| **Neo4j DB Sync Service** (`apps/neo4jdb-sync`, port 4007) | NestJS worker | Listens to user lifecycle events, syncs MongoDB user docs into Neo4j nodes, ensures graph consistency | RabbitMQ consumer, REST health | MongoDB (source of truth), Neo4j (target graph), RabbitMQ, Datadog metrics |

### Shared Infrastructure Containers

| Container | Purpose | Consumers |
|-----------|---------|-----------|
| **MongoDB** (`decode-mongodb`, port 27017) | Primary document store for user, wallet, notification, session, follower snapshot collections. | Auth, User, Wallet, Relationship, Notification, Neo4j Sync |
| **Redis** (`decode-redis`, port 6379) | Caching, rate limiting, session storage, WebSocket presence. | API Gateway, Auth, User, Wallet, Notification, Relationship |
| **Neo4j** (`decode-neo4j`, ports 7474/7687) | Graph database backing social relationships. | Relationship service, Neo4j Sync |
| **RabbitMQ** (`decode-rabbitmq`, ports 5672/15672) | Message broker for async operations (emails, notifications, sync jobs). | Auth, Email worker, Notification, Relationship, Neo4j Sync |

---

## Level 3 – Component View

### API Gateway (`apps/api-gateway`)
- **Purpose**: BFF aggregation layer enforcing authentication, schema validation, and cross-service orchestration.
- **Key Components**
  | Component | Type | Description | Dependencies |
  |-----------|------|-------------|--------------|
  | `AuthController`, `UsersController`, `WalletController`, `RelationshipController`, `NotificationController`, `HealthController` | Controllers | REST endpoints per bounded context, converts HTTP payloads into service calls. | Module-specific services |
  | Module Services (`auth.service.ts`, `users.service.ts`, etc.) | Services | Coordinate requests to downstream microservices, map responses to DTOs, apply error translation. | External service clients, cache |
  | `ExternalServiceClient`s (`auth-service.client.ts`, etc.) | Infrastructure | Axios-based HTTP clients with retries, circuit-breaker friendly config. | Downstream service URLs |
  | `RedisCacheService`, `MongoSessionStore` | Infrastructure | Cache user sessions, throttle repeated requests. | Redis, MongoDB |
  | Cross-cutting packages (`guards`, `interceptors`, `pipes`, `filters`) | Platform | Enforce auth (JWT/session), request throttling, Datadog tracing, validation. | Nest middleware stack |
- **Data/Flows**: Receives HTTPS/WebSocket, authenticates via Auth service (SSO/session tokens), hits respective microservice, aggregates and returns responses. Emits metrics via Datadog interceptors.

### Auth Service (`apps/auth`)
- **Purpose**: Owns user identity lifecycle, device trust, and secure session/token issuance.
- **Key Components**
  | Component | Type | Description | Integrations |
  |-----------|------|-------------|--------------|
  | `AuthController` | Controller | Public REST endpoints for register/login, OTP, device, password, session, SSO operations. | Services layer |
  | `RegisterService`, `LoginService`, `SessionService`, `PasswordService`, `InfoService`, `DeviceFingerprintService`, `SsoService`, `TwoFactorAuthService` | Domain services | Encapsulate business logic for each sub-domain (email verification, login heuristics, refresh tokens, pass resets, OTP). | MongoDB collections (`users`, `sessions`, `device_fingerprints`), Redis, RabbitMQ |
  | DTO + Validation layer (`./dto/*.ts`) | Contracts | Strict payload schemas to guard API boundary. | Controllers |
  | Guards & Decorators (`auth.guard.ts`, `service.guard.ts`, `current-user.decorator.ts`) | Security | Validates JWT/session tokens, enforces service-to-service trust. | JWT utilities, Redis cache |
  | `datadog/metrics` module | Observability | Emits latency & throughput metrics. | Datadog APM |
- **Data/Flows**: Writes primary user records to MongoDB, caches fingerprint & rate limit entries in Redis, publishes email jobs to RabbitMQ, issues JWTs consumed by other services.

### User Service (`apps/user`)
- **Purpose**: Manages mutable profile data, username/email policies, privacy controls, and service-specific responses.
- **Key Components**
  | Component | Type | Description | Dependencies |
  |-----------|------|-------------|--------------|
  | `UserController` | Controller | REST endpoints for profile CRUD, username/email updates, account deactivation, service-only APIs. | Services layer |
  | Services (`profile.service.ts`, `email.service.ts`, `username.service.ts`, `deactivate.service.ts`, `search.service.ts`, `services-response.service.ts`) | Domain services | Handle validation, persistence, event publication per domain command. | MongoDB `users`, Redis cache, Auth service (verify service JWT) |
  | `user.schema.ts` & DTOs | Data modeling | Defines Mongoose schema and transport contracts. | MongoDB |
  | `services-jwt.strategy.ts`, guards, decorators | Security | Allows authorized internal services to call privileged endpoints. | Auth service |
  | `redis.infrastructure.ts` | Infra | Provides caching primitives for profile lookups and search results. | Redis |
- **Data/Flows**: Reads/writes user docs, invalidates caches after mutations, emits sanitized service responses to other containers.

### Relationship Service (`apps/relationship`)
- **Purpose**: Implements social graph (follow, block, interest graph) plus recommendation/search capabilities.
- **Key Components**
  | Component | Type | Description | Dependencies |
  |-----------|------|-------------|--------------|
  | `RelationshipController` | Controller | HTTP endpoints for follow/unfollow, block/unblock, suggestions, mutuals, follower snapshots. | Services layer |
  | Services (`follow`, `block`, `user`, `interest`, `mutual`, `suggest`, `search`, `follower-snapshot`) | Domain services | Compose operations between Neo4j graph queries and Mongo snapshots, enforce authorization. | Neo4j driver, MongoDB, Redis, RabbitMQ events |
  | Infrastructure (`neo4j.infrastructure.ts`, `cache/redis.infrastructure.ts`) | Infra | Provides graph session factory, wraps Cypher execution, caches computed recommendations. | Neo4j, Redis |
  | Guards & Decorators | Security | Optional auth guard enables anonymous browsing with degraded data. | Auth service |
  | `follower-snapshot.schema.ts` | Data | Mongoose schema storing periodic aggregates for analytics. | MongoDB |
- **Data/Flows**: Accepts commands from API Gateway, persists snapshots, updates graph nodes/edges, publishes events (e.g., follow) to RabbitMQ for downstream consumers (notifications, analytics).

### Wallet Service (`apps/wallet`)
- **Purpose**: Links external blockchain wallets to Decode identities, controls primary wallet designation, validates signatures.
- **Key Components**
  | Component | Type | Description | Dependencies |
  |-----------|------|-------------|--------------|
  | `WalletController` | Controller | REST endpoints for wallet linking, verification, listing, and primary selection. | Services layer |
  | Services (`auth.service.ts`, `link.service.ts`, `primary.service.ts`) | Domain services | Manage wallet session creation, signature validation, wallet state transitions. | MongoDB `wallets`, Auth service (wallet session creation endpoints) |
  | `crypto.utils.ts` | Utility | Ethereum address validation, message signing helpers. | ethers/web3 libs |
  | `external-services/auth-service.client.ts` | Infra | Calls Auth SSO endpoints to create wallet sessions. | Auth service |
  | Guards & JWT strategy | Security | Accepts service JWT tokens for inter-service operations. | Auth service |
  | Redis infrastructure | Infra | Stores wallet session cache and throttles linking attempts. | Redis |
- **Data/Flows**: Persists wallet docs (address, chain, verification status), marks one as primary, requests wallet sessions from Auth service to guard operations.

### Notification Service (`apps/notification`)
- **Purpose**: Durable notification store plus push gateway over WebSocket & RabbitMQ.
- **Key Components**
  | Component | Type | Description | Dependencies |
  |-----------|------|-------------|--------------|
  | `NotificationController` | Controller | REST endpoints for CRUD, pagination, mark read/unread. | `NotificationService` |
  | `NotificationGateway` | WebSocket gateway | Socket.IO namespace that authenticates users and streams events. | Redis adapter for scaling |
  | `NotificationService`, `NotificationPushService` | Services | Persist notifications to MongoDB, fan-out to WebSocket sessions, ack RabbitMQ messages. | MongoDB, RabbitMQ, Redis |
  | `rabbitmq.controller.ts` | Controller | Dedicated consumer controller bound to queues/exchanges. | RabbitMQ |
  | Infrastructure (`rabbitmq.infrastructure.ts`, `redis.infrastructure.ts`, `websocket.infrastructure.ts`) | Infra | Provides channel pooling, pub/sub fan-out, socket server bootstrap. | RabbitMQ, Redis |
  | JWT Strategy & guards | Security | Validates service tokens for internal publish requests and user JWT for sockets. | Auth service |
- **Data/Flows**: Consumes events (follow, email, general alerts) from RabbitMQ, writes to MongoDB, notifies active WebSocket clients, exposes history via REST.

### Email Worker (`apps/email-worker`)
- **Purpose**: Dedicated worker for transactional emails.
- **Key Components**
  | Component | Type | Description | Dependencies |
  |-----------|------|-------------|--------------|
  | `EmailWorkerController` | Controller | Health + admin endpoints. | Services |
  | `RabbitmqService` | Infrastructure | Declares queues/bindings, consumes email jobs. | RabbitMQ |
  | `EmailWorkerService` | Worker service | Selects Handlebars-like templates, merges payload, invokes SMTP transport, handles retries and DLQ. | Templates, SMTP provider |
  | `email.templates.ts` | Templates | Catalog of domain-specific email layouts (verification, device trust, password reset). | Used by service |
  | Metrics module | Observability | Emits success/failure counters. | Datadog |
- **Data/Flows**: Receives messages from Auth/Notification services, renders email, sends via configured SMTP, reports success/failure back via logs/metrics.

### Neo4j DB Sync (`apps/neo4jdb-sync`)
- **Purpose**: Maintains parity between MongoDB documents and Neo4j graph nodes/relationships.
- **Key Components**
  | Component | Type | Description | Dependencies |
  |-----------|------|-------------|--------------|
  | `Neo4jdbSyncController` | Controller | Health and manual trigger endpoints. | `UserSyncService` |
  | `UserSyncService` | Worker service | Processes RabbitMQ events (user created/updated/deleted), translates documents into Cypher queries, handles retries. | RabbitMQ, MongoDB, Neo4j |
  | Infrastructure (`neo4j.infrastructure.ts`, `rabbitmq.infrastructure.ts`) | Infra | Connection pools + channel management, ensures idempotent sync. | Neo4j, RabbitMQ |
  | DTOs (`create-user.dto.ts`, `update-user.dto.ts`) | Contracts | Input mapping for sync messages. | Event producers |
- **Data/Flows**: Subscribes to user lifecycle queues, fetches authoritative data from MongoDB if needed, upserts Neo4j nodes/relationships, emits metrics.

### Shared Infrastructure Components
- **MongoDB Collections**: `users`, `wallets`, `notifications`, `sessions`, `device_fingerprints`, `follower_snapshots`.
- **Redis Namespaces**: Session store, rate limit buckets, WebSocket presence, recommendation cache, wallet-session tokens.
- **RabbitMQ Exchanges/Queues**: `email.events`, `notification.events`, `user.sync.events`, `relationship.events`.
- **Observability**: Each service opts into `common/datadog` module exporting metrics + traces; health endpoints at `/health` & `/healthz`.

---

## Using This Document
- Use the Level 2 tables to draw container diagrams (actors → API Gateway → downstream services → infrastructure).
- Use the Level 3 sections to illustrate component relationships inside each container (controllers → services → infrastructure adapters).
- Update this file whenever a new microservice, queue, or major component is added to keep diagrams accurate.
