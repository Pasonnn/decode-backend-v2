version: "3.8"

services:
  # ==================== MICROSERVICES ONLY ====================
  # This configuration runs only the microservices
  # External databases (MongoDB, Redis, Neo4j, RabbitMQ) are cloud-hosted
  # Only API Gateway and Auth are exposed to external traffic

  # API Gateway - Main entry point (EXPOSED)
  api-gateway:
    build:
      context: .
      dockerfile: apps/api-gateway/Dockerfile
      target: production
    container_name: decode-api-gateway
    restart: unless-stopped
    env_file:
      - .env
    environment:
      NODE_ENV: production
      API_GATEWAY_PORT: 4000
      API_GATEWAY_HOST: 0.0.0.0
      # Service communication URLs using Docker service names
      AUTH_SERVICE_URL: http://auth:4001
      USER_SERVICE_URL: http://user:4002
      EMAIL_SERVICE_URL: http://email-worker:4003
      RELATIONSHIP_SERVICE_URL: http://relationship:4004
      WALLET_SERVICE_URL: http://wallet:4005
      NOTIFICATION_SERVICE_URL: http://notification:4006
    ports:
      - "4000:4000" # Exposed to external traffic
    depends_on:
      - auth
      - user
      - wallet
      - relationship
      - notification
    networks:
      - decode-network
    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "require('http').get('http://localhost:4000/health', (res) => { process.exit(res.statusCode === 200 ? 0 : 1) })",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Auth Service (EXPOSED)
  auth:
    build:
      context: .
      dockerfile: apps/auth/Dockerfile
      target: production
    container_name: decode-auth
    restart: unless-stopped
    env_file:
      - .env
    environment:
      NODE_ENV: production
      AUTH_PORT: 4001
      AUTH_HOST: 0.0.0.0
      # Service communication URLs using Docker service names
      USER_SERVICE_URL: http://user:4002
      EMAIL_SERVICE_URL: http://email-worker:4003
      RELATIONSHIP_SERVICE_URL: http://relationship:4004
      WALLET_SERVICE_URL: http://wallet:4005
      NOTIFICATION_SERVICE_URL: http://notification:4006
    ports:
      - "4001:4001" # Exposed to external traffic
    networks:
      - decode-network
    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "require('http').get('http://localhost:4001/health', (res) => { process.exit(res.statusCode === 200 ? 0 : 1) })",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # User Service (INTERNAL ONLY)
  user:
    build:
      context: .
      dockerfile: apps/user/Dockerfile
      target: production
    container_name: decode-user
    restart: unless-stopped
    env_file:
      - .env
    environment:
      NODE_ENV: production
      USER_PORT: 4002
      USER_HOST: 0.0.0.0
    # No external port exposure - internal only
    networks:
      - decode-network
    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "require('http').get('http://localhost:4002/health', (res) => { process.exit(res.statusCode === 200 ? 0 : 1) })",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Email Worker Service (INTERNAL ONLY)
  email-worker:
    build:
      context: .
      dockerfile: apps/email-worker/Dockerfile
      target: production
    container_name: decode-email-worker
    restart: unless-stopped
    env_file:
      - .env
    environment:
      NODE_ENV: production
      EMAIL_PORT: 4003
      EMAIL_HOST: 0.0.0.0
    # No external port exposure - internal only
    networks:
      - decode-network
    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "require('http').get('http://localhost:4003/health', (res) => { process.exit(res.statusCode === 200 ? 0 : 1) })",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Relationship Service (INTERNAL ONLY)
  relationship:
    build:
      context: .
      dockerfile: apps/relationship/Dockerfile
      target: production
    container_name: decode-relationship
    restart: unless-stopped
    env_file:
      - .env
    environment:
      NODE_ENV: production
      RELATIONSHIP_PORT: 4004
      RELATIONSHIP_HOST: 0.0.0.0
    # No external port exposure - internal only
    networks:
      - decode-network
    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "require('http').get('http://localhost:4004/health', (res) => { process.exit(res.statusCode === 200 ? 0 : 1) })",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Wallet Service (INTERNAL ONLY)
  wallet:
    build:
      context: .
      dockerfile: apps/wallet/Dockerfile
      target: production
    container_name: decode-wallet
    restart: unless-stopped
    env_file:
      - .env
    environment:
      NODE_ENV: production
      WALLET_PORT: 4005
      WALLET_HOST: 0.0.0.0
    # No external port exposure - internal only
    networks:
      - decode-network
    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "require('http').get('http://localhost:4005/health', (res) => { process.exit(res.statusCode === 200 ? 0 : 1) })",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Notification Service (INTERNAL ONLY)
  notification:
    build:
      context: .
      dockerfile: apps/notification/Dockerfile
      target: production
    container_name: decode-notification
    restart: unless-stopped
    env_file:
      - .env
    environment:
      NODE_ENV: production
      NOTIFICATION_PORT: 4006
      NOTIFICATION_HOST: 0.0.0.0
    # No external port exposure - internal only
    networks:
      - decode-network
    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "require('http').get('http://localhost:4006/health', (res) => { process.exit(res.statusCode === 200 ? 0 : 1) })",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Neo4j DB Sync Service (INTERNAL ONLY)
  neo4jdb-sync:
    build:
      context: .
      dockerfile: apps/neo4jdb-sync/Dockerfile
      target: production
    container_name: decode-neo4jdb-sync
    restart: unless-stopped
    env_file:
      - .env
    environment:
      NODE_ENV: production
      NEO4JDB_SYNC_PORT: 4007
      NEO4JDB_SYNC_HOST: 0.0.0.0
    # No external port exposure - internal only
    networks:
      - decode-network
    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "require('http').get('http://localhost:4007/health', (res) => { process.exit(res.statusCode === 200 ? 0 : 1) })",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

# ==================== NETWORKS ====================
networks:
  decode-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
