version: "3.8"

services:
  # ==================== MICROSERVICES ONLY ====================
  # This configuration runs only the microservices
  # External databases (MongoDB, Redis, Neo4j, RabbitMQ) are cloud-hosted
  # Only API Gateway and Auth are exposed to external traffic

  # API Gateway - Main entry point (EXPOSED)
  api-gateway:
    image: ghcr.io/decode-labs-web3/decode-api-gateway:latest
    container_name: decode-api-gateway
    restart: unless-stopped
    env_file:
      - .env
      - .env.decode-observe
    environment:
      NODE_ENV: production
      API_GATEWAY_PORT: 4000
      API_GATEWAY_HOST: 0.0.0.0
      # Service communication URLs using Docker service names
      AUTH_SERVICE_URL: http://auth:4001
      USER_SERVICE_URL: http://user:4002
      RELATIONSHIP_SERVICE_URL: http://relationship:4004
      WALLET_SERVICE_URL: http://wallet:4005
      NOTIFICATION_SERVICE_URL: http://notification:4006
      # Datadog observability
      DD_SERVICE: decode-api-gateway
      DD_VERSION: 1.0.0
    ports:
      - "4000:4000" # Exposed to external traffic
    depends_on:
      - auth
      - user
      - wallet
      - relationship
      - notification
      - datadog-agent
    networks:
      - decode-network
    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "require('http').get('http://localhost:4000/health', (res) => { process.exit(res.statusCode === 200 ? 0 : 1) })",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Auth Service (EXPOSED)
  auth:
    image: ghcr.io/decode-labs-web3/decode-auth:latest
    container_name: decode-auth
    restart: unless-stopped
    env_file:
      - .env
      - .env.decode-observe
    environment:
      NODE_ENV: production
      AUTH_PORT: 4001
      AUTH_HOST: 0.0.0.0
      # Service communication URLs using Docker service names
      USER_SERVICE_URL: http://user:4002
      RELATIONSHIP_SERVICE_URL: http://relationship:4004
      WALLET_SERVICE_URL: http://wallet:4005
      NOTIFICATION_SERVICE_URL: http://notification:4006
      # Datadog observability
      DD_SERVICE: decode-auth
      DD_VERSION: 1.0.0
    ports:
      - "4001:4001" # Exposed to external traffic

    networks:
      - decode-network
    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "require('http').get('http://localhost:4001/health', (res) => { process.exit(res.statusCode === 200 ? 0 : 1) })",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # User Service (INTERNAL ONLY)
  user:
    image: ghcr.io/decode-labs-web3/decode-user:latest
    container_name: decode-user
    restart: unless-stopped
    env_file:
      - .env
      - .env.decode-observe
    environment:
      NODE_ENV: production
      USER_PORT: 4002
      USER_HOST: 0.0.0.0
      # Service communication URLs using Docker service names
      AUTH_SERVICE_URL: http://auth:4001
      # Datadog observability
      DD_SERVICE: decode-user
      DD_VERSION: 1.0.0
    # No external port exposure - internal only

    networks:
      - decode-network
    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "require('http').get('http://localhost:4002/health', (res) => { process.exit(res.statusCode === 200 ? 0 : 1) })",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Relationship Service (INTERNAL ONLY)
  relationship:
    image: ghcr.io/decode-labs-web3/decode-relationship:latest
    container_name: decode-relationship
    restart: unless-stopped
    env_file:
      - .env
      - .env.decode-observe
    environment:
      NODE_ENV: production
      RELATIONSHIP_PORT: 4004
      RELATIONSHIP_HOST: 0.0.0.0
      # Service communication URLs using Docker service names
      AUTH_SERVICE_URL: http://auth:4001
      # Datadog observability
      DD_SERVICE: decode-relationship
      DD_VERSION: 1.0.0
    # No external port exposure - internal only

    networks:
      - decode-network
    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "require('http').get('http://localhost:4004/health', (res) => { process.exit(res.statusCode === 200 ? 0 : 1) })",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Wallet Service (INTERNAL ONLY)
  wallet:
    image: ghcr.io/decode-labs-web3/decode-wallet:latest
    container_name: decode-wallet
    restart: unless-stopped
    env_file:
      - .env
      - .env.decode-observe
    environment:
      NODE_ENV: production
      WALLET_PORT: 4005
      WALLET_HOST: 0.0.0.0
      # Service communication URLs using Docker service names
      AUTH_SERVICE_URL: http://auth:4001
      # Datadog observability
      DD_SERVICE: decode-wallet
      DD_VERSION: 1.0.0
    # No external port exposure - internal only
    networks:
      - decode-network
    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "require('http').get('http://localhost:4005/health', (res) => { process.exit(res.statusCode === 200 ? 0 : 1) })",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Notification Service (EXPOSED for WebSocket)
  notification:
    image: ghcr.io/decode-labs-web3/decode-notification:latest
    container_name: decode-notification
    restart: unless-stopped
    env_file:
      - .env
      - .env.decode-observe
    environment:
      NODE_ENV: production
      NOTIFICATION_PORT: 4006
      NOTIFICATION_HOST: 0.0.0.0
      # Service communication URLs using Docker service names
      AUTH_SERVICE_URL: http://auth:4001
      # Datadog observability
      DD_SERVICE: decode-notification
      DD_VERSION: 1.0.0
    ports:
      - "4006:4006" # Exposed for WebSocket connections

    networks:
      - decode-network
    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "require('http').get('http://localhost:4006/health', (res) => { process.exit(res.statusCode === 200 ? 0 : 1) })",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Neo4j DB Sync Service (INTERNAL ONLY)
  neo4jdb-sync:
    image: ghcr.io/decode-labs-web3/decode-neo4jdb-sync:latest
    container_name: decode-neo4jdb-sync
    restart: unless-stopped
    env_file:
      - .env
      - .env.decode-observe
    environment:
      NODE_ENV: production
      NEO4JDB_SYNC_PORT: 4007
      NEO4JDB_SYNC_HOST: 0.0.0.0
      # Service communication URLs using Docker service names
      AUTH_SERVICE_URL: http://auth:4001
      # Datadog observability
      DD_SERVICE: decode-neo4jdb-sync
      DD_VERSION: 1.0.0
    # No external port exposure - internal only

    networks:
      - decode-network
    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "require('http').get('http://localhost:4007/health', (res) => { process.exit(res.statusCode === 200 ? 0 : 1) })",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ==================== DATADOG AGENT ====================
  datadog-agent:
    image: gcr.io/datadoghq/agent:7
    container_name: dd-agent
    restart: unless-stopped
    env_file:
      - .env.decode-observe
    environment:
      - DD_SITE=ap1.datadoghq.com
      - DD_ENV=prod
      - DD_PROCESS_AGENT_ENABLED=true
      - DD_DOGSTATSD_NON_LOCAL_TRAFFIC=true
      - DD_APM_NON_LOCAL_TRAFFIC=true
      - DD_CONTAINER_EXCLUDE="name:dd-agent"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /proc/:/host/proc/:ro
      - /sys/fs/cgroup/:/host/sys/fs/cgroup:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
    networks:
      - decode-network


# ==================== NETWORKS ====================
networks:
  decode-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
