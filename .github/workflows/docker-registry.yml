name: Docker Registry Management

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'list'
        type: choice
        options:
          - list
          - cleanup
          - security-scan
      environment:
        description: 'Environment to target'
        required: true
        default: 'production'
        type: choice
        options:
          - staging
          - production

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ==================== LIST IMAGES ====================
  list-images:
    if: github.event.inputs.action == 'list'
    runs-on: ubuntu-latest

    steps:
      - name: List Docker images
        run: |
          echo "Listing Docker images in registry..."
          echo "Registry: ${{ env.REGISTRY }}"
          echo "Repository: ${{ env.IMAGE_NAME }}"
          echo ""

          # List all tags
          curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/orgs/${{ github.repository_owner }}/packages/container/${{ github.event.repository.name }}/versions" \
            | jq -r '.[] | "\(.metadata.container.tags[0] // "untagged") - \(.created_at) - \(.size_in_bytes) bytes"'

  # ==================== CLEANUP OLD IMAGES ====================
  cleanup-images:
    if: github.event.inputs.action == 'cleanup'
    runs-on: ubuntu-latest

    steps:
      - name: Cleanup old Docker images
        run: |
          echo "Cleaning up old Docker images..."

          # Get all image versions
          versions=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/orgs/${{ github.repository_owner }}/packages/container/${{ github.event.repository.name }}/versions")

          # Keep last 10 versions, delete the rest
          echo "$versions" | jq -r '.[10:] | .[].id' | while read version_id; do
            if [ -n "$version_id" ]; then
              echo "Deleting version: $version_id"
              curl -X DELETE -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
                "https://api.github.com/orgs/${{ github.repository_owner }}/packages/container/${{ github.event.repository.name }}/versions/$version_id"
            fi
          done

          echo "Cleanup completed"

  # ==================== SECURITY SCAN ====================
  security-scan:
    if: github.event.inputs.action == 'security-scan'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=semver,pattern={{version}}
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ steps.meta.outputs.tags }}
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Generate security report
        run: |
          echo "Security scan completed for: ${{ steps.meta.outputs.tags }}"
          echo "Results uploaded to GitHub Security tab"
